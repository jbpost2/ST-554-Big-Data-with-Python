<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.57">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2025-03-31">

<title>Using MLlib from pyspark to Fit Machine Learning Models – ST 554 Analysis of Big Data (with Python)</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">ST 554 Analysis of Big Data (with Python)</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link active" href="../index.html" aria-current="page"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/jbpost2/ST-554-Big-Data-With-Python"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-reader-toggle quarto-navigation-tool px-1" onclick="window.quartoToggleReader(); return false;" title="Toggle reader mode">
  <div class="quarto-reader-toggle-btn">
  <i class="bi"></i>
  </div>
</a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Using <code>MLlib</code> from <code>pyspark</code> to Fit Machine Learning Models</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Analysis of Big Data</span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 1: Learning <code>python</code></span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/01-Course_Goals_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Course Goals &amp; Other Resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/02-Basic_Use_Of_Python.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Basic Use of Python</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/03-Modules.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modules</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/04-JupyterLab_Notebooks_Markdown.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Markdown Capabilities</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/05-List_Basics_Strings.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">List Basics &amp; Strings</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/06-Numeric_Types_Booleans.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numeric Types (Int and Float) &amp; Booleans</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/07-Common_Uses_For_Data_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Common Uses for Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/08-User_Defined_Functions.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">User Defined Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/09-Control_Flow.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Control Flow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/10-Lists_Tuples.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Lists and Tuples</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/11-Dictionaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dictionaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/12-Numpy.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>NumPy</code></span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 2: Dealing with Data in <code>python</code></span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/13-EDA_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Exploratory Data Analysis</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/14-Pandas_Series.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>Pandas</code> Series</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/15-Pandas_Data_Frames.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas Data Frames</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/16-Pandas_For_Reading_Data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Pandas for Reading Raw Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/17-Numerical_Summaries.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Numerical Summaries</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/18-More_Function_Writing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">More on Writing Functions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/19-Plotting_matplotlib.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plotting with <code>matplotlib</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/20-Plotting_pandas.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Plotting with <code>pandas</code></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/21-Error_Handling.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Error Handling</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 3: Basics of Predictive Modeling</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/22-Big_Recap_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Big Recap!</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/23-Fitting_Evaluating_SLR_Models_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Fitting &amp; Evaluating SLR Models</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/24-Prediction_Testing_Training_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Prediction and Training/Test Set Ideas</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/25-Cross_Validation_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Cross Validation</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/26-Multiple_Linear_Regression_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Multiple Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../01_Programming_in_python/27-LASSO_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">LASSO Models</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 4: Big Data Management</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/01-Big_Data_Basics_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Big Data Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/02-Role_of_Statistics_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">The Role of Statistics in Big Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/03-Databases_SQL.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Storage and Basic SQL</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/04-SQL_Joins_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL Joins</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/05-SQL_Resources.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SQL Resources</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/06-Data_Pipelines_Storage_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Data Pipelines &amp; Data Storage</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/07-Legacy_Software_HDFS_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Legacy Big Data Software: Hadoop Distributed File System</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/08-Connecting_to_JupyterHub.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Connecting to our JupyterHub</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/09-Spark_for_Big_Data_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>spark</code>: Big Data Software</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/10-pyspark_RDD_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>pyspark</code>: Resilient Distributed Data Sets</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/11-pyspark_pandas_on_Spark_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>pyspark</code>: Pandas-on-Spark</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../02_Big_Data_Management/12-pyspark_Spark_SQL_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><code>pyspark</code>: Spark SQL</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 5: Modeling Data</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/01-Modeling_Data_Recap_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modeling Data Recap</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/02-Modeling_Example_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Modeling Example</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/03-Logistic_Regression_Basics_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic Regression Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/04-Logistic_Regression_Extensions_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Logistic Regression Extensions</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/05-Regularized_Regression_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regularized Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/06-Loss_Functions_and_Model_Metrics_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Loss Functions &amp; Model Metrics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/07-Classification_And_Regression_Trees_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Classification &amp; Regression Trees</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/08-Bagging_And_Random_Forests_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Bagging &amp; Random Forests</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/09-kNN_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">k Nearest Neighbors</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/10-MLLibBasics_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spark MLlib Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/11-MLPipelines_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLPipelines</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/12-MLflow_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLflow</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../03_Modeling_Data/13-MLOps_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">MLOps</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false">
 <span class="menu-text">Topic 6: Streaming Data</span></a>
          <a class="sidebar-item-toggle text-start collapsed" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="false" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 ">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/01-Streaming_Data_Concepts_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Streaming Data Concepts</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/02-Common_Streaming_Tasks.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Common Streaming Tasks</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/03-Spark_Structured_Streaming_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Spark Structured Streaming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/04-Reading_Writing_Streams_With_Spark_Structured_Streaming_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Reading &amp; Writing Streams with Spark Structured Streaming</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/05-Transformations_Windowing_Aggregations_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Streaming Transformations, Windowing, &amp; Aggregations</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../04_Streaming_Data/06-Streaming_Joins_Landing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Streaming Joins</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#using-cross-validation-to-select-our-model" id="toc-using-cross-validation-to-select-our-model" class="nav-link active" data-scroll-target="#using-cross-validation-to-select-our-model">Using Cross-Validation to Select Our Model</a></li>
  <li><a href="#pipelines-and-the-trainingtest-split" id="toc-pipelines-and-the-trainingtest-split" class="nav-link" data-scroll-target="#pipelines-and-the-trainingtest-split">Pipelines and the Training/Test Split</a></li>
  <li><a href="#mlflow-basics" id="toc-mlflow-basics" class="nav-link" data-scroll-target="#mlflow-basics"><code>MLflow</code> Basics</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Using <code>MLlib</code> from <code>pyspark</code> to Fit Machine Learning Models</h1>
</div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">2025-03-31</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>Start our <code>spark</code> session.</p>
<div id="2bdcc3f9-b2f8-45e5-ba9e-653b7b61fee7" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.sql <span class="im">import</span> SparkSession</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>spark <span class="op">=</span> SparkSession.builder.getOrCreate()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Setting default log level to "WARN".
To adjust logging level use sc.setLogLevel(newLevel). For SparkR, use setLogLevel(newLevel).
24/03/08 17:02:19 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</code></pre>
</div>
</div>
<p>Now read in a data set using <code>pandas</code> and convert it to a <code>spark</code> SQL style data frame.</p>
<div id="9d4e18e1-0cb5-41e1-a472-11089adc8f7a" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>bike_data <span class="op">=</span> pd.read_csv(<span class="st">"bikeDetails.csv"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>bike_data.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="2">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">name</th>
<th data-quarto-table-cell-role="th">selling_price</th>
<th data-quarto-table-cell-role="th">year</th>
<th data-quarto-table-cell-role="th">seller_type</th>
<th data-quarto-table-cell-role="th">owner</th>
<th data-quarto-table-cell-role="th">km_driven</th>
<th data-quarto-table-cell-role="th">ex_showroom_price</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Royal Enfield Classic 350</td>
<td>175000</td>
<td>2019</td>
<td>Individual</td>
<td>1st owner</td>
<td>350</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Honda Dio</td>
<td>45000</td>
<td>2017</td>
<td>Individual</td>
<td>1st owner</td>
<td>5650</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Royal Enfield Classic Gunmetal Grey</td>
<td>150000</td>
<td>2018</td>
<td>Individual</td>
<td>1st owner</td>
<td>12000</td>
<td>148114.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Yamaha Fazer FI V 2.0 [2016-2018]</td>
<td>65000</td>
<td>2015</td>
<td>Individual</td>
<td>1st owner</td>
<td>23000</td>
<td>89643.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Yamaha SZ [2013-2014]</td>
<td>20000</td>
<td>2011</td>
<td>Individual</td>
<td>2nd owner</td>
<td>21000</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Convert to a spark SQL data frame.</p>
<div id="bd795d76-463a-4260-b8de-f999d6592ed4" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>bike <span class="op">=</span> spark.createDataFrame(bike_data)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>bike.show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-------------+----+-----------+---------+---------+-----------------+
|                name|selling_price|year|seller_type|    owner|km_driven|ex_showroom_price|
+--------------------+-------------+----+-----------+---------+---------+-----------------+
|Royal Enfield Cla...|       175000|2019| Individual|1st owner|      350|              NaN|
|           Honda Dio|        45000|2017| Individual|1st owner|     5650|              NaN|
|Royal Enfield Cla...|       150000|2018| Individual|1st owner|    12000|         148114.0|
|Yamaha Fazer FI V...|        65000|2015| Individual|1st owner|    23000|          89643.0|
|Yamaha SZ [2013-2...|        20000|2011| Individual|2nd owner|    21000|              NaN|
+--------------------+-------------+----+-----------+---------+---------+-----------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<p>We’ll fit a linear regression model using log selling price as our response and log km driven, year, and a 1st owner indicator variable as our predictors. This means we need to create some new columns and drop a bunch of others. - We also <strong>need to rename the response</strong> as ‘label’.<br>
- These first steps can easily be done using the <code>SQLTransformer()</code>, <code>StringIndexer()</code>, and <code>Binarizer()</code> <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.ml.html">functions from <code>pyspark.ml.feature</code></a> - Using the <code>MLlib</code> functions will allow us to place these transformations into a <code>pipeline</code> (which we’ll do shortly).</p>
<div id="d1bc8d13-8a31-4ea3-a73f-8063b5eace96" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.feature <span class="im">import</span> SQLTransformer, StringIndexer, Binarizer, VectorAssembler</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>First let’s try to create our dummy variable. This isn’t as easy as you’d like (nothing in here really is!). We can first take the string to a numeric index. Then we can binary-ize that!</p>
<p>We’ll use <code>StringIndexer()</code> first. An <a href="https://spark.apache.org/docs/latest/ml-features.html#stringindexer">example is given here</a>. This is an estimator that we can use the <code>.fit()</code> method on. Then we can use the <code>.transform()</code> method on that.</p>
<div id="d5cc9eab-7352-444f-b6b4-f8a7cc041dab" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>indexer <span class="op">=</span> StringIndexer(inputCols <span class="op">=</span> [<span class="st">"owner"</span>], outputCols <span class="op">=</span> [<span class="st">"owner_numeric"</span>])</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>indexerTrans <span class="op">=</span> indexer.fit(bike) <span class="co">#now indexerTrans will have a .transform() method</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>indexerTrans.transform(bike).show(<span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>                                                                                </code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+
|                name|selling_price|year|seller_type|    owner|km_driven|ex_showroom_price|owner_numeric|
+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+
|Royal Enfield Cla...|       175000|2019| Individual|1st owner|      350|              NaN|          0.0|
|           Honda Dio|        45000|2017| Individual|1st owner|     5650|              NaN|          0.0|
|Royal Enfield Cla...|       150000|2018| Individual|1st owner|    12000|         148114.0|          0.0|
|Yamaha Fazer FI V...|        65000|2015| Individual|1st owner|    23000|          89643.0|          0.0|
|Yamaha SZ [2013-2...|        20000|2011| Individual|2nd owner|    21000|              NaN|          1.0|
|    Honda CB Twister|        18000|2010| Individual|1st owner|    60000|          53857.0|          0.0|
|Honda CB Hornet 160R|        78500|2018| Individual|1st owner|    17000|          87719.0|          0.0|
|Royal Enfield Bul...|       180000|2008| Individual|2nd owner|    39000|              NaN|          1.0|
|Hero Honda CBZ ex...|        30000|2010| Individual|1st owner|    32000|              NaN|          0.0|
|  Bajaj Discover 125|        50000|2016| Individual|1st owner|    42000|          60122.0|          0.0|
|         Yamaha FZ16|        35000|2015| Individual|1st owner|    32000|          78712.0|          0.0|
|          Honda Navi|        28000|2016| Individual|2nd owner|    10000|          47255.0|          1.0|
|Bajaj Avenger Str...|        80000|2018| Individual|1st owner|    21178|          95955.0|          0.0|
|       Yamaha YZF R3|       365000|2019| Individual|1st owner|     1127|         351680.0|          0.0|
|             Jawa 42|       185000|2020| Individual|1st owner|     1700|              NaN|          0.0|
|Suzuki Access 125...|        25000|2012| Individual|1st owner|    55000|          58314.0|          0.0|
|  Hero Honda Glamour|        25000|2006| Individual|1st owner|    27000|              NaN|          0.0|
|    Yamaha YZF R15 S|        40000|2010| Individual|2nd owner|    45000|         117926.0|          1.0|
|Royal Enfield Cla...|       150000|2018| Individual|1st owner|    23000|         148114.0|          0.0|
|         Yamaha FZ25|       120000|2018| Individual|1st owner|    39000|         132680.0|          0.0|
|Hero Passion Pro 110|        15000|2008| Individual|1st owner|    60000|              NaN|          0.0|
|Honda Navi [2016-...|        26000|2016| Individual|1st owner|    17450|          44389.0|          0.0|
|      Honda Activa i|        32000|2013| Individual|2nd owner|    20696|          53900.0|          1.0|
|       Jawa Standard|       180000|2019| Individual|1st owner|     2000|              NaN|          0.0|
|Royal Enfield Thu...|       110000|2016| Individual|1st owner|    20000|              NaN|          0.0|
|    Honda Dream Yuga|        25000|2012| Individual|1st owner|    35000|          56147.0|          0.0|
|TVS Apache RTR 16...|        80000|2018| Individual|1st owner|    15210|              NaN|          0.0|
|Honda Navi [2016-...|        42000|2017| Individual|1st owner|    24000|          44389.0|          0.0|
|Yamaha Fazer [200...|        40000|2013| Individual|3rd owner|    35000|          84751.0|          2.0|
|Hero Honda Splend...|        21000|2009| Individual|1st owner|    10000|              NaN|          0.0|
+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+
only showing top 30 rows
</code></pre>
</div>
</div>
<p>Alright, now let’s conver that to a 0/1 indicator with <code>Binarizer()</code>.</p>
<div id="8dea17f3-5b2f-48d0-b29e-33748801c87c" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>binaryTrans <span class="op">=</span> Binarizer(threshold <span class="op">=</span> <span class="fl">0.5</span>, inputCol <span class="op">=</span> <span class="st">"owner_numeric"</span>, outputCol <span class="op">=</span> <span class="st">"owner_indicator"</span>)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>binaryTrans.transform(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    indexerTrans.transform(bike)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>).show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+---------------+
|                name|selling_price|year|seller_type|    owner|km_driven|ex_showroom_price|owner_numeric|owner_indicator|
+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+---------------+
|Royal Enfield Cla...|       175000|2019| Individual|1st owner|      350|              NaN|          0.0|            0.0|
|           Honda Dio|        45000|2017| Individual|1st owner|     5650|              NaN|          0.0|            0.0|
|Royal Enfield Cla...|       150000|2018| Individual|1st owner|    12000|         148114.0|          0.0|            0.0|
|Yamaha Fazer FI V...|        65000|2015| Individual|1st owner|    23000|          89643.0|          0.0|            0.0|
|Yamaha SZ [2013-2...|        20000|2011| Individual|2nd owner|    21000|              NaN|          1.0|            1.0|
|    Honda CB Twister|        18000|2010| Individual|1st owner|    60000|          53857.0|          0.0|            0.0|
|Honda CB Hornet 160R|        78500|2018| Individual|1st owner|    17000|          87719.0|          0.0|            0.0|
|Royal Enfield Bul...|       180000|2008| Individual|2nd owner|    39000|              NaN|          1.0|            1.0|
|Hero Honda CBZ ex...|        30000|2010| Individual|1st owner|    32000|              NaN|          0.0|            0.0|
|  Bajaj Discover 125|        50000|2016| Individual|1st owner|    42000|          60122.0|          0.0|            0.0|
|         Yamaha FZ16|        35000|2015| Individual|1st owner|    32000|          78712.0|          0.0|            0.0|
|          Honda Navi|        28000|2016| Individual|2nd owner|    10000|          47255.0|          1.0|            1.0|
|Bajaj Avenger Str...|        80000|2018| Individual|1st owner|    21178|          95955.0|          0.0|            0.0|
|       Yamaha YZF R3|       365000|2019| Individual|1st owner|     1127|         351680.0|          0.0|            0.0|
|             Jawa 42|       185000|2020| Individual|1st owner|     1700|              NaN|          0.0|            0.0|
|Suzuki Access 125...|        25000|2012| Individual|1st owner|    55000|          58314.0|          0.0|            0.0|
|  Hero Honda Glamour|        25000|2006| Individual|1st owner|    27000|              NaN|          0.0|            0.0|
|    Yamaha YZF R15 S|        40000|2010| Individual|2nd owner|    45000|         117926.0|          1.0|            1.0|
|Royal Enfield Cla...|       150000|2018| Individual|1st owner|    23000|         148114.0|          0.0|            0.0|
|         Yamaha FZ25|       120000|2018| Individual|1st owner|    39000|         132680.0|          0.0|            0.0|
+--------------------+-------------+----+-----------+---------+---------+-----------------+-------------+---------------+
only showing top 20 rows
</code></pre>
</div>
</div>
<p>Great! Now the easy part. We just want to create some log variables and select only certain columns. The <code>SQLTransformer()</code> allows for (only) basic SQL commands. Note we want our response to be called <code>label</code> so we’ll rename it here.</p>
<div id="5b17fcfb-c334-4bce-a31f-76495305ecb0" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>sqlTrans <span class="op">=</span> SQLTransformer(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    statement <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="st">                SELECT owner_indicator, year, log(km_driven) as log_km_driven, log(selling_price) as label FROM __THIS__</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="st">                """</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="eddd2f65-bb66-4854-996c-127f23ba1a79" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>sqlTrans.transform(</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>    binaryTrans.transform(</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>        indexerTrans.transform(bike)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>).show(<span class="dv">30</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+----+------------------+------------------+
|owner_indicator|year|     log_km_driven|             label|
+---------------+----+------------------+------------------+
|            0.0|2019| 5.857933154483459|12.072541252905651|
|            0.0|2017| 8.639410824140487|10.714417768752456|
|            0.0|2018| 9.392661928770137|11.918390573078392|
|            0.0|2015|10.043249494911286|11.082142548877775|
|            1.0|2011|  9.95227771670556| 9.903487552536127|
|            0.0|2010|11.002099841204238| 9.798127036878302|
|            0.0|2018| 9.740968623038354|  11.2708539037705|
|            1.0|2008|10.571316925111784|12.100712129872347|
|            0.0|2010|10.373491181781864|10.308952660644293|
|            0.0|2016|10.645424897265505|10.819778284410283|
|            0.0|2015|10.373491181781864| 10.46310334047155|
|            1.0|2016| 9.210340371976184|10.239959789157341|
|            0.0|2018|   9.9607181859904|11.289781913656018|
|            0.0|2019| 7.027314514039777| 12.80765263256463|
|            0.0|2020| 7.438383530044307|12.128111104060462|
|            0.0|2012|10.915088464214607|10.126631103850338|
|            0.0|2006|10.203592144986466|10.126631103850338|
|            1.0|2010|10.714417768752456|10.596634733096073|
|            0.0|2018|10.043249494911286|11.918390573078392|
|            0.0|2018|10.571316925111784|11.695247021764184|
|            0.0|2008|11.002099841204238| 9.615805480084347|
|            0.0|2016| 9.767094927630573|10.165851817003619|
|            1.0|2013| 9.937695723865865|10.373491181781864|
|            0.0|2019| 7.600902459542082|12.100712129872347|
|            0.0|2016| 9.903487552536127|11.608235644774552|
|            0.0|2012| 10.46310334047155|10.126631103850338|
|            0.0|2018|  9.62970838525334|11.289781913656018|
|            0.0|2017|10.085809109330082|10.645424897265505|
|            1.0|2013| 10.46310334047155|10.596634733096073|
|            0.0|2009| 9.210340371976184|  9.95227771670556|
+---------------+----+------------------+------------------+
only showing top 30 rows
</code></pre>
</div>
</div>
<p>We also <strong>need to put the predictors into a single column</strong> called ‘features’.<br>
Placing multiple columns into one can be done via <code>VectorAssembler()</code> from <code>pyspark.ml.feature</code>.</p>
<div id="cdcf2144-ca15-4c0b-8eaf-70cc823a8ca8" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>assembler <span class="op">=</span> VectorAssembler(inputCols <span class="op">=</span> [<span class="st">"year"</span>, <span class="st">"log_km_driven"</span>, <span class="st">"owner_indicator"</span>], outputCol <span class="op">=</span> <span class="st">"features"</span>, handleInvalid <span class="op">=</span> <span class="st">'keep'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we are passing what would be the result columns from the previous SQL transform we did. The <code>VectorAssembler()</code> also has a <code>.transform()</code> method. Let’s see how these would be used together to produce a new data set.</p>
<div id="c68a3a66-8303-4f92-8e41-e43b5cc47437" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>assembler.transform(</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    sqlTrans.transform(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>        binaryTrans.transform(</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>            indexerTrans.transform(bike)</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>).show(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+----+------------------+------------------+--------------------+
|owner_indicator|year|     log_km_driven|             label|            features|
+---------------+----+------------------+------------------+--------------------+
|            0.0|2019| 5.857933154483459|12.072541252905651|[2019.0,5.8579331...|
|            0.0|2017| 8.639410824140487|10.714417768752456|[2017.0,8.6394108...|
|            0.0|2018| 9.392661928770137|11.918390573078392|[2018.0,9.3926619...|
|            0.0|2015|10.043249494911286|11.082142548877775|[2015.0,10.043249...|
|            1.0|2011|  9.95227771670556| 9.903487552536127|[2011.0,9.9522777...|
|            0.0|2010|11.002099841204238| 9.798127036878302|[2010.0,11.002099...|
|            0.0|2018| 9.740968623038354|  11.2708539037705|[2018.0,9.7409686...|
|            1.0|2008|10.571316925111784|12.100712129872347|[2008.0,10.571316...|
|            0.0|2010|10.373491181781864|10.308952660644293|[2010.0,10.373491...|
|            0.0|2016|10.645424897265505|10.819778284410283|[2016.0,10.645424...|
+---------------+----+------------------+------------------+--------------------+
only showing top 10 rows
</code></pre>
</div>
</div>
<p>Awesome! Our data is now transformed to have the new variables we want and the data is in the format needed to fit model using <code>MLlib</code>. Specifically: - A column named <code>label</code> that is the response variable - A column named <code>features</code> that is a column containing all the predictor values together</p>
<p>Next step, we’ll fit a basic multiple linear regression model using the <code>LinearRegression()</code> function from <code>pyspark.ml.regression</code>. This function does regularized regression (Elastic net, which includes LASSO and Ridge Regression as special cases) so there are a few set up parameters we can modify to just get the usual MLR fit.</p>
<div id="69aded9d-78ae-4b53-9b41-4810faac0ea1" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.regression <span class="im">import</span> LinearRegression</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e48e2a16-40cf-495d-9c59-fabb8e04fcb3" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression(regParam <span class="op">=</span> <span class="dv">0</span>, elasticNetParam <span class="op">=</span> <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can use the <code>.fit()</code> method on the transformed data we made above.</p>
<div id="8ab09c66-b292-43cc-9db7-07fff2cf0e02" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>lr_data <span class="op">=</span> assembler.transform(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                sqlTrans.transform(</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                    binaryTrans.transform(</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>                        indexerTrans.transform(bike)</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>                    )</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>                )</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>lr_data</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>DataFrame[owner_indicator: double, year: bigint, log_km_driven: double, label: double, features: vector]</code></pre>
</div>
</div>
<div id="edf05787-5cb1-422d-9a46-a3e22433c346" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>lrModel <span class="op">=</span> lr.fit(lr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>24/03/08 17:03:10 WARN Instrumentation: [1d9ded2d] regParam is zero, which might cause numerical instability and overfitting.
                                                                                </code></pre>
</div>
</div>
<p>We can inspect the model fit using attributes of our <code>lrModel</code> object.</p>
<div id="3fba9c91-ba10-488d-8e8f-795fa3f7df8b" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Intercept: </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> <span class="bu">str</span>(lrModel.intercept), <span class="st">"Coefficients: </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> <span class="bu">str</span>(lrModel.coefficients))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intercept: -151.65184885852284 Coefficients: [0.08175654813171404,-0.22825871252866586,0.10021253855848164]</code></pre>
</div>
</div>
<p>Let’s inspect the training set RMSE and other model fit metrics.</p>
<div id="8081aeaf-b29f-4596-8586-05ddc2c06f98" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>trainingSummary <span class="op">=</span> lrModel.summary</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>trainingSummary.residuals.show(<span class="dv">5</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"RMSE: </span><span class="sc">%f</span><span class="st">"</span> <span class="op">%</span> trainingSummary.rootMeanSquaredError)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"r2: </span><span class="sc">%f</span><span class="st">"</span> <span class="op">%</span> trainingSummary.r2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+--------------------+
|           residuals|
+--------------------+
|-0.00495628658079...|
| -0.5646701626673813|
|  0.7294822208803797|
| 0.28700612130943703|
| -0.6856003220335012|
+--------------------+
only showing top 5 rows

RMSE: 0.509892
r2: 0.485191</code></pre>
</div>
</div>
<p>Of course we will often want to do predictions as well. This is easy to do! The model itself actually becomes a transformer once it is fit! We just use the <code>.transform()</code> method and pass it data similar in format to that on which the model was trained. Here we’ll just look at the prediction from the data used to fit the model.</p>
<div id="1adaaba3-85eb-435a-ba23-8e4c9ea0101e" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> lrModel.transform(lr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="fa5bcea2-110d-4581-9a88-7001b7009ef7" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>preds.show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+----+------------------+------------------+--------------------+------------------+
|owner_indicator|year|     log_km_driven|             label|            features|        prediction|
+---------------+----+------------------+------------------+--------------------+------------------+
|            0.0|2019| 5.857933154483459|12.072541252905651|[2019.0,5.8579331...|12.077497539486444|
|            0.0|2017| 8.639410824140487|10.714417768752456|[2017.0,8.6394108...|11.279087931419838|
|            0.0|2018| 9.392661928770137|11.918390573078392|[2018.0,9.3926619...|11.188908352198013|
|            0.0|2015|10.043249494911286|11.082142548877775|[2015.0,10.043249...|10.795136427568337|
|            1.0|2011|  9.95227771670556| 9.903487552536127|[2011.0,9.9522777...|10.589087874569628|
+---------------+----+------------------+------------------+--------------------+------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<div id="85bfad84-e0e8-40d0-9d4d-fd5a261b2053" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>preds.select(<span class="st">"label"</span>, <span class="st">"prediction"</span>).show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+------------------+
|             label|        prediction|
+------------------+------------------+
|12.072541252905651|12.077497539486444|
|10.714417768752456|11.279087931419838|
|11.918390573078392|11.188908352198013|
|11.082142548877775|10.795136427568337|
| 9.903487552536127|10.589087874569628|
+------------------+------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<p>Just a sanity check to show we get the same RMSE if we do it with these values:</p>
<div id="a4951eef-915f-4ad8-8ecc-7ffb4e346313" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>my_preds <span class="op">=</span> preds.select(<span class="st">"label"</span>, <span class="st">"prediction"</span>).toPandas()</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>np.sqrt(np.mean((my_preds[<span class="st">"label"</span>]<span class="op">-</span>my_preds[<span class="st">"prediction"</span>])<span class="op">**</span><span class="dv">2</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>0.5098915575316225</code></pre>
</div>
</div>
<p>One more sanity check. Compare with <code>sklearn</code>.</p>
<p>Note: I had an error with the <code>scipy</code> module not being recognized. I opened a new terminal window (file –&gt; New Launcher, choose Terminal at the bottom) and had to submit the code: <code>pip install scipy --force</code></p>
<div id="238ffde7-c389-44e5-a9ac-3b586335a956" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn <span class="im">import</span> linear_model</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>bike_data <span class="op">=</span> pd.read_csv(<span class="st">"https://www4.stat.ncsu.edu/~online/datasets/bikeDetails.csv"</span>)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'log_selling_price'</span>] <span class="op">=</span> np.log(bike_data[<span class="st">'selling_price'</span>])</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'log_km_driven'</span>] <span class="op">=</span> np.log(bike_data[<span class="st">'km_driven'</span>])</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>bike_data[<span class="st">'one_owner'</span>] <span class="op">=</span> pd.get_dummies(data <span class="op">=</span> bike_data[<span class="st">'owner'</span>])[<span class="st">'1st owner'</span>]</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>mlr_fit <span class="op">=</span> linear_model.LinearRegression() <span class="co">#Create a reg object</span></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>mlr_fit.fit(bike_data[[<span class="st">'year'</span>,<span class="st">'log_km_driven'</span>,<span class="st">'one_owner'</span>]], bike_data[<span class="st">'log_selling_price'</span>].values)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mlr_fit.intercept_, mlr_fit.coef_)</span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(mean_squared_error(bike_data[<span class="st">'log_selling_price'</span>], mlr_fit.predict(bike_data[[<span class="st">"year"</span>, <span class="st">"log_km_driven"</span>, <span class="st">"one_owner"</span>]]), squared <span class="op">=</span> <span class="va">False</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-151.55163631488233 [ 0.08175655 -0.22825871 -0.10021254]
0.5098915575316225</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/jupyter-jbpost2@ncsu.edu/.local/lib/python3.9/site-packages/sklearn/metrics/_regression.py:483: FutureWarning: 'squared' is deprecated in version 1.4 and will be removed in 1.6. To calculate the root mean squared error, use the function'root_mean_squared_error'.
  warnings.warn(</code></pre>
</div>
</div>
<p>Cool! We’ve fit an MLR model using the <code>pyspark</code> <code>MLlib</code> library!</p>
<section id="using-cross-validation-to-select-our-model" class="level1">
<h1>Using Cross-Validation to Select Our Model</h1>
<p>Of course we know that what we care about is the quality of the prediction our model makes on <strong>data it wasn’t trained on</strong>. Generally, this means we need to either - split our data into a training and test (sometimes called validation) set - use cross-validation</p>
<p>And of course, we’ve talked about the need for both when selecting from many types of models.</p>
<p>Let’s focus on doing k-fold CV using <code>pyspark</code>. We need to set up our grid of tuning parameters (if applicable) and then run our CV algorithm. This can be done using the <code>ParamGridBuilder()</code> and <code>CrossValidator()</code> functions from <code>pyspark.ml.tuning</code>, respectively.</p>
<div id="67652b75-cc9a-4fe7-8fa0-49e3bd13fad2" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.tuning <span class="im">import</span> CrossValidator, ParamGridBuilder</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The only tuning parameter we’ll worry about is the <code>regParam</code>. which is <span class="math inline">\(\lambda\)</span> in the penalty part of the loss function: <span class="math display">\[\alpha(\lambda||w||_1)+(1-\alpha)(\lambda/2||w||_2^2)\]</span> If we set the <code>elasticNetParam</code> to 1 (<span class="math inline">\(\alpha\)</span> above) then we are doing LASSO regression.</p>
<p>We can see some <a href="https://spark.apache.org/docs/latest/api/python/reference/pyspark.ml.html#regression">details for each algorithm via the help files</a>. We can look at how well the model does when we use different amounts of LASSO regularization. We use <code>ParamGridBuilder()</code> and <code>.addGrid()</code> to specify the tuning parameter values. Then finally we use the <code>.build()</code> method to instruct it to build the grid.</p>
<div id="749f9944-99b6-47b4-a98a-4b34f8b4a455" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression()</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>paramGrid <span class="op">=</span> ParamGridBuilder() <span class="op">\</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.regParam, [<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>]) <span class="op">\</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.elasticNetParam, [<span class="dv">1</span>]) <span class="op">\</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    .build()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next up, we can use the <code>CrossValidator()</code> function to run k-fold CV over the grid of tuning parameters we just set up.</p>
<p>We need to tell <code>pyspark</code> what loss function to use when evaluating. This is done via the <code>RegressionEvaluator()</code> function from <code>pyspark.ml.evaluation</code>. To override the default metric used we can specify it explicitly using the <code>metricName=</code> argument when calling the function. <code>rmse</code> is the default here.</p>
<div id="5baecc00-3a23-4361-867e-06b25bdf1214" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml.evaluation <span class="im">import</span> RegressionEvaluator</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="f3e7849f-d98d-4715-ace8-05bc31e0dc0c" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>crossval <span class="op">=</span> CrossValidator(estimator <span class="op">=</span> lr,</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>                          estimatorParamMaps <span class="op">=</span> paramGrid,</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                          evaluator <span class="op">=</span> RegressionEvaluator(metricName<span class="op">=</span><span class="st">'rmse'</span>),</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>                          numFolds<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ve now set up the <code>crossval</code> object. Just like with <code>sklearn</code> we now use the <code>.fit()</code> method to actually fit the models.</p>
<div id="0a508983-2880-44ae-b288-5bb2308ed1e9" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>cvModel <span class="op">=</span> crossval.fit(lr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>24/03/08 17:06:44 WARN Instrumentation: [e4f7ec65] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:06:49 WARN Instrumentation: [96732fed] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:06:52 WARN Instrumentation: [ccc91038] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:06:54 WARN Instrumentation: [04867e84] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:06:56 WARN Instrumentation: [e89224fc] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:06:58 WARN Instrumentation: [ca268c57] regParam is zero, which might cause numerical instability and overfitting.</code></pre>
</div>
</div>
<p>By default, the only model returned is the <strong>best</strong> model as measured by our Loss function.</p>
<p>To determine which model was returned we can look at the <code>.avgMetrics</code> attribute along with the <code>paramGrid</code> object we used to fit the models.</p>
<div id="bdd219e7-b39d-4a2f-a679-1cc94adfe19a" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="bu">list</span>(<span class="bu">zip</span>([<span class="dv">0</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.15</span>], cvModel.avgMetrics))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="29">
<pre><code>[(0, 0.5112406194486974),
 (0.05, 0.5136269855905575),
 (0.1, 0.5235001947739562),
 (0.15, 0.5395464815213404)]</code></pre>
</div>
</div>
<p>We can see the best model’s parameter estimates as well.</p>
<div id="b2f19cee-96e1-448b-99bc-14d0d8e89735" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cvModel.bestModel._java_obj.intercept(), cvModel.bestModel._java_obj.coefficients())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>-151.6518488577565 [0.08175654813133452,-0.22825871252886246,0.10021253855757116]</code></pre>
</div>
</div>
<p>As with the single linear model fit we did above, this new object, <code>cvModel</code>, is now a transformation as well. This allows us to get prediction using the best fit model. If we had a test set we could use it to get the test set prediction easily. As we didn’t split into a test set, let’s just see how to use it to predict on the training data (i.e.&nbsp;return the fitted values for the model).</p>
<div id="e15c4b9a-3b9c-4733-85a6-ee2eed11d066" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>predsCV <span class="op">=</span> cvModel.transform(lr_data)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e1e2f6d6-85fe-42df-b47c-1173bc0aa901" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>predsCV.select(<span class="st">"label"</span>, <span class="st">"prediction"</span>).show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+------------------+
|             label|        prediction|
+------------------+------------------+
|12.072541252905651|12.077497539485364|
|10.714417768752456|11.279087931418985|
|11.918390573078392|11.188908352196648|
|11.082142548877775|10.795136427567968|
| 9.903487552536127|10.589087874569884|
+------------------+------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<p>As our model chosen was not regularized, we get the same predictions as previous!</p>
<div id="0bf159e1-cd81-469f-860d-d9d623bbdc09" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>preds.select(<span class="st">"label"</span>, <span class="st">"prediction"</span>).show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+------------------+------------------+
|             label|        prediction|
+------------------+------------------+
|12.072541252905651|12.077497539486444|
|10.714417768752456|11.279087931419838|
|11.918390573078392|11.188908352198013|
|11.082142548877775|10.795136427568337|
| 9.903487552536127|10.589087874569628|
+------------------+------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<p>We can find the training RMSE by passing these predictions to the <code>RegressionEvaluator().evaluate()</code> method.</p>
<div id="ab922b95-c156-42ba-8ee5-47198257caf6" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>RegressionEvaluator().evaluate(cvModel.transform(lr_data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>0.509891557531623</code></pre>
</div>
</div>
</section>
<section id="pipelines-and-the-trainingtest-split" class="level1">
<h1>Pipelines and the Training/Test Split</h1>
<p>Of course we often want to have a training and test set so we can do all of our model fitting and tuning on the training set and then see how different model types compare on the test set. We should always split our data into training and test sets first, before doing transformations. Reason being: - If we do transformations on the training set, we want to use the exact same transformations on the test set - For instance, if we center some predictors (subtract the mean) in our training set, we want to subtract the mean of the <strong>training</strong> set to standardize the test set values prior to doing test set predictions! - By splitting the data first, we can make sure we aren’t using any test data (and the knowledge that comes with it) when training our models</p>
<p>By setting up a <strong>pipeline</strong> in <code>MLlib</code> we can easily (ha, that’s kind of a joke) create the sequence of transformations/model fits and apply those same transformations on our test set!</p>
<p>Let’s start with the training/test split. This can be done using the <code>.randomSplit()</code> method on a spark SQL style data frame.</p>
<div id="eea5f9d6-be15-4e2e-8f73-06cc555e9245" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>train, test <span class="op">=</span> bike.randomSplit([<span class="fl">0.8</span>,<span class="fl">0.2</span>], seed <span class="op">=</span> <span class="dv">1</span>)</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(train.count(), test.count())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>840 221</code></pre>
</div>
</div>
<p>Now that we’ve split our data we can <strong>set up</strong> the transformations to do. Just like with other spark stuff, things are set up as a DAG and done only at run time.<br>
We created the transformation plans previously so we’ll just pull them down here for clarity.</p>
<div id="3bd14b8c-f4d7-4a8b-832d-1506c81a6fab" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="co">#Sequence of transformations</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a><span class="co">#indexerTrans</span></span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a><span class="co">#binaryTrans</span></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a><span class="co">#sqlTrans</span></span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a><span class="co">#assembler</span></span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a><span class="co">#(linear model or other model here!)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We are then ready to create our pipeline that includes these transformations and the model that we want to fit. We use the <code>Pipeline()</code> function from the <code>pyspark.ml</code> module to set up our sequence of transformations/estimators.</p>
<div id="aeb06165-54e7-4184-b9ce-d0efd5fe34ac" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pyspark.ml <span class="im">import</span> Pipeline</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="930fceb4-f177-4fa5-9a67-337e26819844" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>lr <span class="op">=</span> LinearRegression()</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>paramGrid <span class="op">=</span> ParamGridBuilder() <span class="op">\</span></span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.regParam, [<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.04</span>, <span class="fl">0.06</span>, <span class="fl">0.1</span>]) <span class="op">\</span></span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>    .addGrid(lr.elasticNetParam, [<span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="dv">1</span>]) <span class="op">\</span></span>
<span id="cb60-5"><a href="#cb60-5" aria-hidden="true" tabindex="-1"></a>    .build()</span>
<span id="cb60-6"><a href="#cb60-6" aria-hidden="true" tabindex="-1"></a>pipeline <span class="op">=</span> Pipeline(stages <span class="op">=</span> [indexerTrans, binaryTrans, sqlTrans, assembler, lr])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Our DAG is now set up and we can use this pipeline within our CV calculation (or basic model fitting). What’s nice is that since it contains all the information about the transformations done, we can easily apply this to a test set and not have to worry about how to do the transformations/prepping of the data on that set.</p>
<p>Instead of using the model type as the <code>estimator</code> we’ll pass the pipeline we’ve set up.</p>
<div id="3cd29241-7948-4521-92ba-3e90655a1bca" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>crossval <span class="op">=</span> CrossValidator(estimator <span class="op">=</span> pipeline,</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>                          estimatorParamMaps <span class="op">=</span> paramGrid,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>                          evaluator <span class="op">=</span> RegressionEvaluator(),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>                          numFolds<span class="op">=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With everything set up, we can now fit our models!</p>
<div id="dbdf6b6d-8cb6-412e-b7bc-4f4f8e302827" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Run cross-validation, and choose the best set of parameters.</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>cvModel <span class="op">=</span> crossval.fit(train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>24/03/08 17:08:42 WARN Instrumentation: [45408c1a] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:43 WARN Instrumentation: [bdf949e2] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:43 WARN Instrumentation: [c9e03b2c] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:44 WARN Instrumentation: [cc03885d] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:45 WARN Instrumentation: [8f5c1468] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:56 WARN Instrumentation: [d5eaed65] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:57 WARN Instrumentation: [e1d0afb2] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:58 WARN Instrumentation: [1e88fc13] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:58 WARN Instrumentation: [769528f1] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:08:59 WARN Instrumentation: [a95045a7] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:10 WARN Instrumentation: [9e6d1f94] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:11 WARN Instrumentation: [778a593a] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:11 WARN Instrumentation: [7a4bdc3a] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:12 WARN Instrumentation: [ffefcfcf] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:12 WARN Instrumentation: [333c0cdd] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:23 WARN Instrumentation: [0c04f6cd] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:24 WARN Instrumentation: [a9177fea] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:24 WARN Instrumentation: [efc198f1] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:25 WARN Instrumentation: [4c91d04f] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:25 WARN Instrumentation: [0d67662a] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:35 WARN Instrumentation: [1f57078a] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:36 WARN Instrumentation: [5973b334] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:36 WARN Instrumentation: [f17e57e2] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:37 WARN Instrumentation: [d043d7d8] regParam is zero, which might cause numerical instability and overfitting.
24/03/08 17:09:37 WARN Instrumentation: [750b1ce7] regParam is zero, which might cause numerical instability and overfitting.</code></pre>
</div>
</div>
<p>Check which model is chosen as the best:</p>
<div id="254ce767-18d7-47b2-ba79-7ddf3844f5f4" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>my_list <span class="op">=</span> []</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="bu">len</span>(paramGrid)):</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    my_list.append([cvModel.avgMetrics[i], paramGrid[i].values()])</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>my_list</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="41">
<pre><code>[[0.5124021026719168, dict_values([0.0, 0.0])],
 [0.5124021026718817, dict_values([0.0, 0.5])],
 [0.5124021026718577, dict_values([0.0, 0.8])],
 [0.5124021026718556, dict_values([0.0, 0.9])],
 [0.5124021026719084, dict_values([0.0, 1.0])],
 [0.5123205996805408, dict_values([0.01, 0.0])],
 [0.5123483858580572, dict_values([0.01, 0.5])],
 [0.5122975622688871, dict_values([0.01, 0.8])],
 [0.5122867285770079, dict_values([0.01, 0.9])],
 [0.5122589945611346, dict_values([0.01, 1.0])],
 [0.5123909761343102, dict_values([0.04, 0.0])],
 [0.5122102563576977, dict_values([0.04, 0.5])],
 [0.5120946331251414, dict_values([0.04, 0.8])],
 [0.5121238218400215, dict_values([0.04, 0.9])],
 [0.51224440770079, dict_values([0.04, 1.0])],
 [0.512663579012802, dict_values([0.06, 0.0])],
 [0.5126627597862455, dict_values([0.06, 0.5])],
 [0.5137013318120469, dict_values([0.06, 0.8])],
 [0.5142717497055167, dict_values([0.06, 0.9])],
 [0.5148905572778366, dict_values([0.06, 1.0])],
 [0.5136433512562688, dict_values([0.1, 0.0])],
 [0.5159728675900753, dict_values([0.1, 0.5])],
 [0.5199269354732108, dict_values([0.1, 0.8])],
 [0.5215278837702534, dict_values([0.1, 0.9])],
 [0.523281713834437, dict_values([0.1, 1.0])]]</code></pre>
</div>
</div>
<p>Use that best model to get test error on the test set.</p>
<div id="3e5818e2-3522-46a3-af5c-e001962df133" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>cvModel.transform(test).show(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>+---------------+----+------------------+------------------+--------------------+------------------+
|owner_indicator|year|     log_km_driven|             label|            features|        prediction|
+---------------+----+------------------+------------------+--------------------+------------------+
|            0.0|2019| 5.857933154483459|12.072541252905651|[2019.0,5.8579331...|11.953749958528732|
|            0.0|2020| 7.438383530044307|12.128111104060462|[2020.0,7.4383835...|11.705822488439821|
|            1.0|2013| 9.937695723865865|10.373491181781864|[2013.0,9.9376957...|10.679205674574945|
|            0.0|2018|10.571316925111784|11.695247021764184|[2018.0,10.571316...|10.919885599143953|
|            0.0|2017| 7.824046010856292|10.915088464214607|[2017.0,7.8240460...|11.405445806006924|
+---------------+----+------------------+------------------+--------------------+------------------+
only showing top 5 rows
</code></pre>
</div>
</div>
<div id="8acc2249-0b6a-48dd-826b-461a380cd802" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>test_error <span class="op">=</span> RegressionEvaluator().evaluate(cvModel.transform(test))</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(test_error)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.5114772577953631</code></pre>
</div>
</div>
<p>Fantastic! We can now set up a pipeline and use CV to fit our model. Then we can take the best model and find test set predictions!</p>
<p>Remember, once we have our final model we fit that model on the entire data set. Then we use it for future predictions and what-not.</p>
</section>
<section id="mlflow-basics" class="level1">
<h1><code>MLflow</code> Basics</h1>
<p>Note: To run this code in our jupyterhub I had to do a few things first. I needed to force install a few modules. Open a new terminal window and do the following:</p>
<p><code>pip install requests --force</code><br>
<code>pip install pyyaml --force</code><br>
<code>pip install entrypoints --force</code></p>
<p>This section is modified from the <a href="https://github.com/mlflow/mlflow/blob/master/examples/sklearn_elasticnet_wine/train.ipynb">tutorial given here</a>. Although this uses <code>sklearn</code>, it can be modified to work with <code>MLlib</code>!</p>
<p>First, they create a function to train an elastic net model specifically on the wine data we’ve used before. This function takes in the <span class="math inline">\(\alpha\)</span> and <span class="math inline">\(L_1\)</span> ratio values from the <code>sklearn</code> <code>ElasticNet()</code> function. This function can then be passed different values of these and the given metrics will be found and logged.</p>
<div id="19f91f92-e399-4361-ac2a-8c7cbc76059f" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Wine Quality Sample</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> train(in_alpha, in_l1_ratio):</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> os</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> warnings</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> sys</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_squared_error, mean_absolute_error, r2_score</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb70-11"><a href="#cb70-11" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> sklearn.linear_model <span class="im">import</span> ElasticNet</span>
<span id="cb70-12"><a href="#cb70-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-13"><a href="#cb70-13" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> mlflow</span>
<span id="cb70-14"><a href="#cb70-14" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> mlflow.sklearn</span>
<span id="cb70-15"><a href="#cb70-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-16"><a href="#cb70-16" aria-hidden="true" tabindex="-1"></a>    <span class="im">import</span> logging</span>
<span id="cb70-17"><a href="#cb70-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-18"><a href="#cb70-18" aria-hidden="true" tabindex="-1"></a>    logging.basicConfig(level<span class="op">=</span>logging.WARN)</span>
<span id="cb70-19"><a href="#cb70-19" aria-hidden="true" tabindex="-1"></a>    logger <span class="op">=</span> logging.getLogger(<span class="va">__name__</span>)</span>
<span id="cb70-20"><a href="#cb70-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-21"><a href="#cb70-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> eval_metrics(actual, pred):</span>
<span id="cb70-22"><a href="#cb70-22" aria-hidden="true" tabindex="-1"></a>        rmse <span class="op">=</span> np.sqrt(mean_squared_error(actual, pred))</span>
<span id="cb70-23"><a href="#cb70-23" aria-hidden="true" tabindex="-1"></a>        mae <span class="op">=</span> mean_absolute_error(actual, pred)</span>
<span id="cb70-24"><a href="#cb70-24" aria-hidden="true" tabindex="-1"></a>        r2 <span class="op">=</span> r2_score(actual, pred)</span>
<span id="cb70-25"><a href="#cb70-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> rmse, mae, r2</span>
<span id="cb70-26"><a href="#cb70-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-27"><a href="#cb70-27" aria-hidden="true" tabindex="-1"></a>    warnings.filterwarnings(<span class="st">"ignore"</span>)</span>
<span id="cb70-28"><a href="#cb70-28" aria-hidden="true" tabindex="-1"></a>    np.random.seed(<span class="dv">40</span>)</span>
<span id="cb70-29"><a href="#cb70-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-30"><a href="#cb70-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Read the wine-quality csv file from the URL</span></span>
<span id="cb70-31"><a href="#cb70-31" aria-hidden="true" tabindex="-1"></a>    csv_url <span class="op">=</span> (</span>
<span id="cb70-32"><a href="#cb70-32" aria-hidden="true" tabindex="-1"></a>        <span class="st">"http://archive.ics.uci.edu/ml/machine-learning-databases/wine-quality/winequality-red.csv"</span></span>
<span id="cb70-33"><a href="#cb70-33" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb70-34"><a href="#cb70-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb70-35"><a href="#cb70-35" aria-hidden="true" tabindex="-1"></a>        data <span class="op">=</span> pd.read_csv(csv_url, sep<span class="op">=</span><span class="st">";"</span>)</span>
<span id="cb70-36"><a href="#cb70-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb70-37"><a href="#cb70-37" aria-hidden="true" tabindex="-1"></a>        logger.exception(</span>
<span id="cb70-38"><a href="#cb70-38" aria-hidden="true" tabindex="-1"></a>            <span class="st">"Unable to download training &amp; test CSV, check your internet connection. Error: </span><span class="sc">%s</span><span class="st">"</span>, e</span>
<span id="cb70-39"><a href="#cb70-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb70-40"><a href="#cb70-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-41"><a href="#cb70-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Split the data into training and test sets. (0.75, 0.25) split.</span></span>
<span id="cb70-42"><a href="#cb70-42" aria-hidden="true" tabindex="-1"></a>    train, test <span class="op">=</span> train_test_split(data)</span>
<span id="cb70-43"><a href="#cb70-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-44"><a href="#cb70-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The predicted column is "quality" which is a scalar from [3, 9]</span></span>
<span id="cb70-45"><a href="#cb70-45" aria-hidden="true" tabindex="-1"></a>    train_x <span class="op">=</span> train.drop([<span class="st">"quality"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-46"><a href="#cb70-46" aria-hidden="true" tabindex="-1"></a>    test_x <span class="op">=</span> test.drop([<span class="st">"quality"</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb70-47"><a href="#cb70-47" aria-hidden="true" tabindex="-1"></a>    train_y <span class="op">=</span> train[[<span class="st">"quality"</span>]]</span>
<span id="cb70-48"><a href="#cb70-48" aria-hidden="true" tabindex="-1"></a>    test_y <span class="op">=</span> test[[<span class="st">"quality"</span>]]</span>
<span id="cb70-49"><a href="#cb70-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-50"><a href="#cb70-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set default values if no alpha is provided</span></span>
<span id="cb70-51"><a href="#cb70-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">float</span>(in_alpha) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb70-52"><a href="#cb70-52" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb70-53"><a href="#cb70-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb70-54"><a href="#cb70-54" aria-hidden="true" tabindex="-1"></a>        alpha <span class="op">=</span> <span class="bu">float</span>(in_alpha)</span>
<span id="cb70-55"><a href="#cb70-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-56"><a href="#cb70-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Set default values if no l1_ratio is provided</span></span>
<span id="cb70-57"><a href="#cb70-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">float</span>(in_l1_ratio) <span class="kw">is</span> <span class="va">None</span>:</span>
<span id="cb70-58"><a href="#cb70-58" aria-hidden="true" tabindex="-1"></a>        l1_ratio <span class="op">=</span> <span class="fl">0.5</span></span>
<span id="cb70-59"><a href="#cb70-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb70-60"><a href="#cb70-60" aria-hidden="true" tabindex="-1"></a>        l1_ratio <span class="op">=</span> <span class="bu">float</span>(in_l1_ratio)</span>
<span id="cb70-61"><a href="#cb70-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-62"><a href="#cb70-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Useful for multiple runs (only doing one run in this sample notebook)</span></span>
<span id="cb70-63"><a href="#cb70-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">with</span> mlflow.start_run():</span>
<span id="cb70-64"><a href="#cb70-64" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Execute ElasticNet</span></span>
<span id="cb70-65"><a href="#cb70-65" aria-hidden="true" tabindex="-1"></a>        lr <span class="op">=</span> ElasticNet(alpha<span class="op">=</span>alpha, l1_ratio<span class="op">=</span>l1_ratio, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb70-66"><a href="#cb70-66" aria-hidden="true" tabindex="-1"></a>        lr.fit(train_x, train_y)</span>
<span id="cb70-67"><a href="#cb70-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-68"><a href="#cb70-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Evaluate Metrics</span></span>
<span id="cb70-69"><a href="#cb70-69" aria-hidden="true" tabindex="-1"></a>        predicted_qualities <span class="op">=</span> lr.predict(test_x)</span>
<span id="cb70-70"><a href="#cb70-70" aria-hidden="true" tabindex="-1"></a>        (rmse, mae, r2) <span class="op">=</span> eval_metrics(test_y, predicted_qualities)</span>
<span id="cb70-71"><a href="#cb70-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-72"><a href="#cb70-72" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Print out metrics</span></span>
<span id="cb70-73"><a href="#cb70-73" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Elasticnet model (alpha=</span><span class="sc">%f</span><span class="st">, l1_ratio=</span><span class="sc">%f</span><span class="st">):"</span> <span class="op">%</span> (alpha, l1_ratio))</span>
<span id="cb70-74"><a href="#cb70-74" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  RMSE: </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> rmse)</span>
<span id="cb70-75"><a href="#cb70-75" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  MAE: </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> mae)</span>
<span id="cb70-76"><a href="#cb70-76" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"  R2: </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> r2)</span>
<span id="cb70-77"><a href="#cb70-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-78"><a href="#cb70-78" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Log parameter, metrics, and model to MLflow</span></span>
<span id="cb70-79"><a href="#cb70-79" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">"alpha"</span>, alpha)</span>
<span id="cb70-80"><a href="#cb70-80" aria-hidden="true" tabindex="-1"></a>        mlflow.log_param(<span class="st">"l1_ratio"</span>, l1_ratio)</span>
<span id="cb70-81"><a href="#cb70-81" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"rmse"</span>, rmse)</span>
<span id="cb70-82"><a href="#cb70-82" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"r2"</span>, r2)</span>
<span id="cb70-83"><a href="#cb70-83" aria-hidden="true" tabindex="-1"></a>        mlflow.log_metric(<span class="st">"mae"</span>, mae)</span>
<span id="cb70-84"><a href="#cb70-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-85"><a href="#cb70-85" aria-hidden="true" tabindex="-1"></a>        mlflow.sklearn.log_model(lr, <span class="st">"model"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With this function set up, we now just call it with different values and it creates logs for them.</p>
<div id="d46d80f2-b850-4089-a729-23f22deb4417" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>train(<span class="fl">0.5</span>, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>2024/03/29 13:51:46 WARNING mlflow.utils.git_utils: Failed to import Git (the Git executable is probably not on your PATH), so Git SHA is not available. Error: No module named 'git'</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Elasticnet model (alpha=0.500000, l1_ratio=0.500000):
  RMSE: 0.7931640229276851
  MAE: 0.6271946374319586
  R2: 0.10862644997792614</code></pre>
</div>
</div>
<div id="9a824103-5f1f-4440-9137-20969c0b33c7" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a>train(<span class="fl">0.5</span>, <span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Elasticnet model (alpha=0.500000, l1_ratio=1.000000):
  RMSE: 0.832819092896359
  MAE: 0.6681279771237894
  R2: 0.017268050734704055</code></pre>
</div>
</div>
<div id="d37a8c7e-328a-46ab-9cbd-733efb8f08d4" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>train(<span class="fl">0.1</span>, <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Elasticnet model (alpha=0.100000, l1_ratio=0.500000):
  RMSE: 0.7308996187375898
  MAE: 0.5615486628017713
  R2: 0.2430813606733676</code></pre>
</div>
</div>
<div id="05ca843a-0b4e-4875-922b-123b170229d8" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>train(<span class="dv">1</span>, <span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Elasticnet model (alpha=1.000000, l1_ratio=0.000000):
  RMSE: 0.7508731220796289
  MAE: 0.5811664801219333
  R2: 0.2011470433755671</code></pre>
</div>
</div>
<p>If not in a docker container we would now be able to call the mlflow UI and look through things. I couldn’t get that to work and gave up! Instead, we can just read in the data it uses in the UI and look at it within python.</p>
<div id="4b6a94ff-0b22-47a9-be4f-bc30e9e3a993" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> mlflow</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a><span class="co">#throws an issue but it returns the data appropriately</span></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>runs <span class="op">=</span> mlflow.search_runs(experiment_ids<span class="op">=</span>[<span class="st">"0"</span>])</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>runs.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">run_id</th>
<th data-quarto-table-cell-role="th">experiment_id</th>
<th data-quarto-table-cell-role="th">status</th>
<th data-quarto-table-cell-role="th">artifact_uri</th>
<th data-quarto-table-cell-role="th">start_time</th>
<th data-quarto-table-cell-role="th">end_time</th>
<th data-quarto-table-cell-role="th">metrics.r2</th>
<th data-quarto-table-cell-role="th">metrics.mae</th>
<th data-quarto-table-cell-role="th">metrics.rmse</th>
<th data-quarto-table-cell-role="th">params.l1_ratio</th>
<th data-quarto-table-cell-role="th">params.alpha</th>
<th data-quarto-table-cell-role="th">tags.mlflow.log-model.history</th>
<th data-quarto-table-cell-role="th">tags.mlflow.source.type</th>
<th data-quarto-table-cell-role="th">tags.mlflow.user</th>
<th data-quarto-table-cell-role="th">tags.mlflow.runName</th>
<th data-quarto-table-cell-role="th">tags.mlflow.source.name</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>65d548898f1e40558fef1624d3d78cc6</td>
<td>0</td>
<td>FINISHED</td>
<td>file:///home/jupyter-jbpost2%40ncsu.edu/mlruns...</td>
<td>2024-03-08 22:15:28.734000+00:00</td>
<td>2024-03-08 22:15:29.939000+00:00</td>
<td>0.201147</td>
<td>0.581166</td>
<td>0.750873</td>
<td>0.0</td>
<td>1.0</td>
<td>[{"run_id": "65d548898f1e40558fef1624d3d78cc6"...</td>
<td>LOCAL</td>
<td>jupyter-jbpost2@ncsu.edu</td>
<td>bedecked-dolphin-527</td>
<td>/opt/tljh/user/envs/pySpark/lib/python3.9/site...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>6f421ddea3b5467889fcbc030ff9c9df</td>
<td>0</td>
<td>FINISHED</td>
<td>file:///home/jupyter-jbpost2%40ncsu.edu/mlruns...</td>
<td>2024-03-08 22:15:26.864000+00:00</td>
<td>2024-03-08 22:15:28.101000+00:00</td>
<td>0.243081</td>
<td>0.561549</td>
<td>0.730900</td>
<td>0.5</td>
<td>0.1</td>
<td>[{"run_id": "6f421ddea3b5467889fcbc030ff9c9df"...</td>
<td>LOCAL</td>
<td>jupyter-jbpost2@ncsu.edu</td>
<td>enthused-ape-110</td>
<td>/opt/tljh/user/envs/pySpark/lib/python3.9/site...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>e79aa57b53084ea79b24950ecbb0284f</td>
<td>0</td>
<td>FINISHED</td>
<td>file:///home/jupyter-jbpost2%40ncsu.edu/mlruns...</td>
<td>2024-03-08 22:15:23.857000+00:00</td>
<td>2024-03-08 22:15:25.117000+00:00</td>
<td>0.017268</td>
<td>0.668128</td>
<td>0.832819</td>
<td>1.0</td>
<td>0.5</td>
<td>[{"run_id": "e79aa57b53084ea79b24950ecbb0284f"...</td>
<td>LOCAL</td>
<td>jupyter-jbpost2@ncsu.edu</td>
<td>wise-worm-607</td>
<td>/opt/tljh/user/envs/pySpark/lib/python3.9/site...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>c40bba6d7d8d43dc8cbce75cfb448b93</td>
<td>0</td>
<td>FINISHED</td>
<td>file:///home/jupyter-jbpost2%40ncsu.edu/mlruns...</td>
<td>2024-03-08 22:15:16.728000+00:00</td>
<td>2024-03-08 22:15:18.462000+00:00</td>
<td>0.108626</td>
<td>0.627195</td>
<td>0.793164</td>
<td>0.5</td>
<td>0.5</td>
<td>[{"run_id": "c40bba6d7d8d43dc8cbce75cfb448b93"...</td>
<td>LOCAL</td>
<td>jupyter-jbpost2@ncsu.edu</td>
<td>welcoming-pug-473</td>
<td>/opt/tljh/user/envs/pySpark/lib/python3.9/site...</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="202e8a7c-5907-493c-a9d7-7aca7871ca77" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>runs.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>Index(['run_id', 'experiment_id', 'status', 'artifact_uri', 'start_time',
       'end_time', 'metrics.r2', 'metrics.mae', 'metrics.rmse',
       'params.l1_ratio', 'params.alpha', 'tags.mlflow.log-model.history',
       'tags.mlflow.source.type', 'tags.mlflow.user', 'tags.mlflow.runName',
       'tags.mlflow.source.name'],
      dtype='object')</code></pre>
</div>
</div>
<div id="dfb34037-48a7-4584-a238-6cc424db46e6" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>runs[[<span class="st">"metrics.rmse"</span>, <span class="st">"metrics.r2"</span>, <span class="st">"metrics.mae"</span>, <span class="st">"params.l1_ratio"</span>, <span class="st">"params.alpha"</span>]].sort_values(<span class="st">"metrics.rmse"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">metrics.rmse</th>
<th data-quarto-table-cell-role="th">metrics.r2</th>
<th data-quarto-table-cell-role="th">metrics.mae</th>
<th data-quarto-table-cell-role="th">params.l1_ratio</th>
<th data-quarto-table-cell-role="th">params.alpha</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>0.730900</td>
<td>0.243081</td>
<td>0.561549</td>
<td>0.5</td>
<td>0.1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">0</td>
<td>0.750873</td>
<td>0.201147</td>
<td>0.581166</td>
<td>0.0</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>0.793164</td>
<td>0.108626</td>
<td>0.627195</td>
<td>0.5</td>
<td>0.5</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>0.832819</td>
<td>0.017268</td>
<td>0.668128</td>
<td>1.0</td>
<td>0.5</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>